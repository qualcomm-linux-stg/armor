
name: "Print Event SHAs"
description: "Run ARMOR tool"
author: "LinuxIntegration"
branding:
  icon: "align-left"
  color: "blue"

inputs:
  event-name:
    description: "github.event_name from the caller"
    required: true
  head-sha:
    description: "Head SHA for the event (PR head or push after)"
    required: true
  base-sha:
    description: "Base SHA for the event (PR base or push before)"
    required: false
    default: ""
  ref:
    description: "Ref associated with the event"
    required: false
    default: ""
  repo:
    description: "owner/repo of the caller"
    required: false
    default: ""
  repo-token:
    description: "Token for GitHub API calls"
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout base commit
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.base-sha }}
        path: base
        fetch-depth: 0

    - name: Checkout head commit
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.head-sha }}
        path: head
        fetch-depth: 0

    - name: Echo paths and SHAs
      shell: bash
      run: |
        echo "Event       : ${{ inputs.event-name }}"
        echo "Base SHA    : ${{ inputs.base-sha }}"
        echo "Head SHA    : ${{ inputs.head-sha }}"
        echo "github-base path : $GITHUB_WORKSPACE/base"
        echo "github-head path : $GITHUB_WORKSPACE/head"


    - name: Verify gcc and Docker installation
      shell: bash
      run: |
        set -e
        gcc --version || { echo "gcc missing"; exit 1; }
        docker --version || { echo "docker missing"; exit 1; }

    - name: Build docker image (use action directory as context)
      shell: bash
      run: |
        set -e
        docker build -t armor_tool:latest -f "${{ github.action_path }}/Dockerfile" "${{ github.action_path }}"

    - name: Install yq
      shell: bash
      run: |
        set -e
        if ! command -v yq >/dev/null 2>&1; then
          sudo apt-get update -y
          sudo apt-get install -y jq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
        fi

    - name: Get changed files
      id: changed-files
      shell: bash
      run: |
        set -e
        # Diff directly using the two trees
        git --git-dir="$GITHUB_WORKSPACE/head/.git" --work-tree="$GITHUB_WORKSPACE/head" diff --name-only ${{ inputs.base-sha }} ${{ inputs.head-sha }} > "$GITHUB_WORKSPACE/changed_files.txt" || true
        echo "Changed files:"
        cat "$GITHUB_WORKSPACE/changed_files.txt" || true

    - name: Parse YAML for headers
      id: parse-yaml
      shell: bash
      run: |
        set -e
        YAML_FILE="$GITHUB_WORKSPACE/public_headers/armor_config.yaml"
        if [[ -f "$YAML_FILE" ]]; then
          echo "Parsing $YAML_FILE"
          yq '.branches.main.headers[]' "$YAML_FILE" > "$GITHUB_WORKSPACE/headers.txt"
          echo "Headers from YAML:"
          cat "$GITHUB_WORKSPACE/headers.txt"
        else
          echo "YAML file not found at $YAML_FILE"
          exit 1
        fi

    - name: Find intersection of changed files and headers
      id: intersection
      shell: bash
      run: |
        set -e
        INTERSECT=$(grep -Fxf "$GITHUB_WORKSPACE/headers.txt" "$GITHUB_WORKSPACE/changed_files.txt" || true)
        echo "$INTERSECT" > "$GITHUB_WORKSPACE/updated_headers_PR.txt"
        if [[ -n "$INTERSECT" ]]; then
          echo "Intersection found:"
          cat "$GITHUB_WORKSPACE/updated_headers_PR.txt"
          echo "has-intersection=true" >> "$GITHUB_OUTPUT"
        else
          echo "No intersection found."
          : > "$GITHUB_WORKSPACE/updated_headers_PR.txt"
          echo "has-intersection=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Build ARMOR tool inside container
      shell: bash
      run: |
        set -euo pipefail
        ACTION_DIR="${{ github.action_path }}"
        docker run -i --rm \
          --user $(id -u):$(id -g) \
          -v "$ACTION_DIR":"$ACTION_DIR" \
          -e ACTION_DIR="$ACTION_DIR" \
          -w "$ACTION_DIR" \
          armor_tool:latest bash -c '
            set -euo pipefail
            chmod +x ./api_compat_check.sh
            ./api_compat_check.sh --package
            echo "$ACTION_DIR/build/armor" > "$ACTION_DIR/.armor_bins_path"
          '

    - name: Run ARMOR per header (collect outputs)
      if: steps.intersection.outputs.has-intersection == 'true'
      id: run-armor
      shell: bash
      env:
        REPORT_FORMAT: "json"
        LOG_LEVEL: "INFO"
        DUMP_AST_DIFF: "true"
      run: |
        set -e
        BASE_PATH="$GITHUB_WORKSPACE/base"
        HEAD_PATH="$GITHUB_WORKSPACE/head"
        INTERSECTION_HEADERS_PATH="$GITHUB_WORKSPACE/updated_headers_PR.txt"
        ARMOR_BINS_PATH="$(cat "${{ github.action_path }}/.armor_bins_path")"

        chmod +x "${{ github.action_path }}/action_script/run_armor.sh"
        "${{ github.action_path }}/action_script/run_armor.sh" "$BASE_PATH" "$HEAD_PATH" "$INTERSECTION_HEADERS_PATH" "$ARMOR_BINS_PATH"

        OUT_ROOT="$(cat "$GITHUB_WORKSPACE/.armor_out_root")"
        echo "out-root=$OUT_ROOT" >> "$GITHUB_OUTPUT"

    - name: Upload updated_headers_PR artifact
      if: steps.intersection.outputs.has-intersection == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: updated_headers_PR
        path: ${{ github.workspace }}/updated_headers_PR.txt

    - name: Upload all armor outputs (artifact)
      if: steps.intersection.outputs.has-intersection == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: armor-output-${{ inputs.head-sha }}
        path: ${{ steps.run-armor.outputs.out-root }}
        if-no-files-found: warn

    - name: Compute compatibility status
      id: compatibility_status
      shell: bash
      run: |
        set -e
        # Expect your run_armor.sh to set status file or output; adjust as needed
        STATUS_FILE="$GITHUB_WORKSPACE/.armor_status"
        if [[ -f "$STATUS_FILE" ]]; then
          STATUS="$(cat "$STATUS_FILE")"
        else
          # Fallback: mark success if outputs exist
          [[ -d "${{ steps.run-armor.outputs.out-root }}" ]] && STATUS="success" || STATUS="failure"
        fi
        echo "Overall status: $STATUS"
        echo "res=$STATUS" >> "$GITHUB_OUTPUT"

    - name: Post PR comment with ARMOR summary
      if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
      shell: bash
      run: |
        set -euo pipefail

        # Inputs and common context
        repo="${{ inputs.repo }}"
        pr="${{ github.event.pull_request.number }}"
        token="${{ inputs.repo-token }}"
        workflow_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        out_root="${{ steps.run-armor.outputs.out-root }}"
        status="${{ steps.compatibility_status.outputs.res }}"

        # Compose the comment body
        header="### ARMOR Compatibility Check\n\n**Overall Status:** \`${status}\`\n"

        # Try to read compat_summary.json if available
        summary_path=""
        if [[ -n "${out_root}" && -d "${out_root}" ]]; then
          summary_path="${out_root}/compat_summary.json"
        fi

        if [[ -n "${summary_path}" && -f "${summary_path}" ]]; then
          # Extract a concise summary if you want; otherwise include raw JSON
          # Example: pull top-level fields into a short line
          short_summary="$(jq -r '
              to_entries
              | map("\(.key): \(.value|tostring)")
              | join(", ")
            ' "${summary_path}" 2>/dev/null || echo "")"

          body="${header}\n**Summary fields:** ${short_summary}\n"
        else
          body="${header}\n"
        fi

        echo ${body}

        # Post the comment to the PR
        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ inputs.repo-token }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/${repo}/issues/${pr}/comments" \
          -d "$body"

